<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FahadFlix</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
    body{background:#141414;color:#fff;min-height:100vh}
    header{background:#000;padding:10px;display:flex;justify-content:space-between;align-items:center}
    header h1{color:#e50914}
    button{background:#e50914;border:none;color:#fff;padding:6px 12px;border-radius:4px;cursor:pointer}
    .container{padding:20px}
    h2{margin:15px 0}
    .row{display:flex;overflow-x:auto;gap:10px}
    .movie-card{min-width:150px;flex:0 0 auto;cursor:pointer}
    .movie-card img{width:100%;border-radius:6px}
    .title{text-align:center;font-size:14px;margin-top:4px}
    #player{width:100%;max-height:70vh;background:#000}
    #loginPage,#profilesPage,#homePage,#playerPage,#episodesPage,#adminPage{display:none}
    .profile-card{display:inline-block;margin:10px;text-align:center;cursor:pointer}
    .profile-card img{width:100px;border-radius:50%}
  </style>
</head>
<body>
  <header>
    <h1>FahadFlix</h1>
    <div>
      <button id="homeBtn">Home</button>
      <button id="adminToggleBtn" style="display:none">Admin</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <div id="loginPage" class="container">
    <h2>Login</h2>
    <input id="email" placeholder="Email"><br><br>
    <input id="password" type="password" placeholder="Password"><br><br>
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Sign Up</button>
  </div>

  <div id="profilesPage" class="container">
    <h2>Select Profile</h2>
    <div id="profilesContainer"></div>
    <input id="newProfileName" placeholder="New profile name">
    <button id="addProfileBtn">Add Profile</button>
  </div>

  <div id="homePage" class="container">
    <input id="search" placeholder="Search...">
    <div id="moviesContainer"></div>
  </div>

  <div id="episodesPage" class="container">
    <button id="backToHome">Back</button>
    <h2 id="showTitle"></h2>
    <div id="episodesContainer"></div>
  </div>

  <div id="playerPage" class="container">
    <button id="playerBackBtn">Back</button>
    <h2 id="playerTitle"></h2>
    <video id="videoPlayer" controls></video><br>
    <button id="toggleSubsBtn">Toggle Subtitles</button>
  </div>

  <div id="adminPage" class="container">
    <h2>Admin Panel</h2>
    <input id="adminTitle" placeholder="Title"><br>
    <input id="adminImg" placeholder="Image URL"><br>
    <input id="adminSrc" placeholder="Video URL (for movies)"><br>
    <input id="adminSubs" placeholder="Subtitles URL (optional)"><br>
    <select id="adminType">
      <option value="movies">Movie</option>
      <option value="shows">Show</option>
    </select><br>
    <button id="addMediaBtn">Add</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCvd_IgPL3_gYjhfplngBboHWjSLRIhhIE",
      authDomain: "fahadflix-storage.firebaseapp.com",
      databaseURL: "https://fahadflix-storage-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fahadflix-storage",
      storageBucket: "fahadflix-storage.appspot.com",
      messagingSenderId: "1064833913945",
      appId: "1:1064833913945:web:bf711e8b364fcfdf2b8d48"
    };
    firebase.initializeApp(firebaseConfig);

    const auth=firebase.auth();
    const db=firebase.database();

    let currentUser=null;
    let activeProfile=null;
    let mediaData={movies:[],shows:[]};

    const loginPage=document.getElementById('loginPage');
    const profilesPage=document.getElementById('profilesPage');
    const homePage=document.getElementById('homePage');
    const playerPage=document.getElementById('playerPage');
    const episodesPage=document.getElementById('episodesPage');
    const adminPage=document.getElementById('adminPage');
    const moviesContainer=document.getElementById('moviesContainer');
    const videoPlayer=document.getElementById('videoPlayer');

    function showPage(id){
      [loginPage,profilesPage,homePage,playerPage,episodesPage,adminPage]
        .forEach(p=>p.style.display='none');
      document.getElementById(id+'Page').style.display='block';
      // ✅ Pause video globally when leaving player
      if(id!=='player') videoPlayer.pause();
    }

    // AUTH
    document.getElementById('loginBtn').onclick=()=>auth.signInWithEmailAndPassword(
      document.getElementById('email').value,
      document.getElementById('password').value
    ).catch(e=>alert(e.message));

    document.getElementById('signupBtn').onclick=()=>auth.createUserWithEmailAndPassword(
      document.getElementById('email').value,
      document.getElementById('password').value
    ).catch(e=>alert(e.message));

    document.getElementById('logoutBtn').onclick=()=>auth.signOut();

    auth.onAuthStateChanged(u=>{
      if(u){ currentUser=u; loadProfiles(); }
      else{ currentUser=null; showPage('login'); }
    });

    // PROFILES
    function loadProfiles(){
      db.ref('profiles/'+currentUser.uid).once('value').then(snap=>{
        const data=snap.val()||{}; const c=document.getElementById('profilesContainer');
        c.innerHTML=''; Object.values(data).forEach(p=>{
          const card=document.createElement('div'); card.className='profile-card';
          card.innerHTML=`<img src="https://placehold.co/100"><div>${p.name}</div>`;
          card.onclick=()=>{activeProfile=p; loadMedia();};
          c.appendChild(card);
        });
        showPage('profiles');
      });
    }
    document.getElementById('addProfileBtn').onclick=()=>{
      const name=document.getElementById('newProfileName').value.trim();
      if(!name) return;
      const ref=db.ref('profiles/'+currentUser.uid).push({name});
      loadProfiles();
    };

    // HOME
    function loadMedia(){
      db.ref('media').once('value').then(snap=>{
        mediaData=snap.val()||{movies:[],shows:[]};
        renderHome();
        showPage('home');
      });
    }

    async function renderHome(search=''){
      moviesContainer.innerHTML='';

      // ✅ Resume Watching row (per profile)
      const resumeSnap=await db.ref(`resume/${currentUser.uid}/${activeProfile.name}`).once('value');
      const resumeData=resumeSnap.val()||{};
      const resumeKeys=Object.keys(resumeData);
      if(resumeKeys.length){
        const titleEl=document.createElement('h2'); titleEl.innerText='Resume Watching';
        moviesContainer.appendChild(titleEl);
        const row=document.createElement('div'); row.className='row';
        resumeKeys.forEach(key=>{
          let item=mediaData.movies.find(m=>m.title===key) || mediaData.shows.find(s=>s.title===key);
          if(item){
            const card=document.createElement('div'); card.className='movie-card';
            card.innerHTML=`<img src="${item.img||''}"><div class="title">${item.title}</div>`;
            card.onclick=()=> item.src ? openPlayer(item.title,item.src,item.subtitles) : openShow(item);
            row.appendChild(card);
          }
        });
        moviesContainer.appendChild(row);
      }

      // Movies / Shows
      [['Movies', mediaData.movies], ['Shows', mediaData.shows]].forEach(([label,arr])=>{
        let filtered=arr||[];
        if(label==='Movies'){
          filtered=filtered.filter(m=>m.src && (!search||m.title.toLowerCase().includes(search.toLowerCase())));
        } else {
          filtered=filtered.filter(m=>!search||m.title.toLowerCase().includes(search.toLowerCase()));
        }
        if(filtered.length){
          const titleEl=document.createElement('h2'); titleEl.innerText=label;
          moviesContainer.appendChild(titleEl);
          const row=document.createElement('div'); row.className='row';
          filtered.forEach(m=>{
            const card=document.createElement('div'); card.className='movie-card';
            card.innerHTML=`<img src="${m.img||''}"><div class="title">${m.title||'Untitled'}</div>`;
            card.onclick=()=> label==='Movies' ? openPlayer(m.title,m.src,m.subtitles) : openShow(m);
            row.appendChild(card);
          });
          moviesContainer.appendChild(row);
        }
      });
    }

    document.getElementById('search').oninput=(e)=>renderHome(e.target.value);

    // SHOW EPISODES
    function openShow(show){
      showPage('episodes');
      document.getElementById('showTitle').innerText=show.title;
      const c=document.getElementById('episodesContainer'); c.innerHTML='';
      (show.episodes||[]).forEach(ep=>{
        const div=document.createElement('div');
        div.className='movie-card';
        div.innerHTML=`<img src="${ep.img||''}"><div class="title">${ep.title}</div>`;
        div.onclick=()=>openPlayer(show.title+' - '+ep.title,ep.src,ep.subtitles);
        c.appendChild(div);
      });
    }

    // PLAYER
    document.getElementById('playerBackBtn').onclick=()=>showPage('home');
    document.getElementById('backToHome').onclick=()=>showPage('home');
    document.getElementById('toggleSubsBtn').onclick=()=>{
      const tracks=videoPlayer.textTracks||[];
      for(let i=0;i<tracks.length;i++) tracks[i].mode=(tracks[i].mode==='showing'?'hidden':'showing');
    };

    async function openPlayer(title,src,subs){
      showPage('player');
      videoPlayer.innerHTML='';
      videoPlayer.src=src||'';
      const snapshot=await db.ref(`resume/${currentUser.uid}/${activeProfile.name}/${title}`).once('value');
      if(snapshot.exists()) videoPlayer.currentTime=snapshot.val();
      videoPlayer.ontimeupdate=()=>{
        if(!videoPlayer.paused){
          db.ref(`resume/${currentUser.uid}/${activeProfile.name}/${title}`).set(videoPlayer.currentTime);
        }
      };
      document.getElementById('playerTitle').innerText=title;
      if(subs){
        const track=document.createElement('track'); track.kind='subtitles'; track.src=subs; track.default=true;
        videoPlayer.appendChild(track);
      }
    }

    // ADMIN
    document.getElementById('addMediaBtn').onclick=()=>{
      const t=document.getElementById('adminTitle').value.trim();
      const img=document.getElementById('adminImg').value.trim();
      const src=document.getElementById('adminSrc').value.trim();
      const subs=document.getElementById('adminSubs').value.trim();
      const type=document.getElementById('adminType').value;
      if(!t||!img||(!src && type==='movies')){ alert('Fill required fields'); return; }
      const obj={title:t,img,src,subtitles:subs};
      mediaData[type].push(obj);
      db.ref('media').set(mediaData);
      alert(type+' added!');
      renderHome();
    };

    document.getElementById('homeBtn').onclick=()=>showPage('home');
    document.getElementById('adminToggleBtn').onclick=()=>showPage('admin');

    // Only show admin if email matches
    auth.onAuthStateChanged(u=>{
      if(u?.email==='fxhdle2@gmail.com') document.getElementById('adminToggleBtn').style.display='inline-block';
      else document.getElementById('adminToggleBtn').style.display='none';
    });
  </script>
</body>
</html>
