<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FahadFlix</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
body{background:#141414;color:#fff;min-height:100vh}
header{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#000}
header h1{color:#e50914;font-size:1.8rem}
header button{background:#e50914;color:#fff;border:none;padding:.5rem 1rem;border-radius:5px;cursor:pointer}
main{padding:1rem}
h2{margin-bottom:1rem}
#movies{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem}
.movie-card{background:#222;padding:1rem;border-radius:10px;transition:transform .2s;cursor:pointer}
.movie-card:hover{transform:scale(1.05)}
.movie-card h3{font-size:1.1rem;margin-bottom:.5rem}
video{width:100%;border-radius:10px}
#profilesContainer{display:flex;flex-wrap:wrap;gap:18px;justify-content:center;margin-top:20px}
.profile-card{width:140px;text-align:center;background:#1b1b1b;padding:8px;border-radius:10px;position:relative}
.profile-card img{width:120px;height:120px;object-fit:cover;border-radius:12px;cursor:pointer}
.profile-card p{margin:6px 0}
.profile-card button{margin-top:4px;width:100%;padding:4px 0;font-size:12px}
.add-area{max-width:520px;margin:18px auto;padding:12px;background:#161616;border-radius:8px;display:flex;gap:8px;align-items:center}
.add-area input[type="text"], .add-area input[type="file"]{flex:1;padding:10px;border-radius:6px;border:none;background:#222;color:#fff}
.add-area button{padding:10px 12px;background:#e50914;border:none;color:#fff;border-radius:6px;cursor:pointer}
.btn{padding:8px 12px;background:#e50914;border:none;border-radius:6px;color:#fff;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.3)}
#playerContainer{margin-top:20px;text-align:center}
#playerContainer video{width:95%;max-width:980px;border-radius:8px;background:#000}
</style>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
</head>
<body>
<div class="container">

<!-- AUTH PAGE -->
<div id="authPage">
  <div class="auth-box">
    <h2>Login or Sign Up</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="signInBtn">Sign In</button>
    <button id="signUpBtn" class="btn ghost">Sign Up</button>
  </div>
</div>

<!-- PROFILES PAGE -->
<div id="profilesPage" style="display:none;">
  <h2>Who's watching?</h2>
  <div class="add-area">
    <input id="newProfileName" type="text" placeholder="New profile name">
    <input id="newProfileImage" type="file" accept="image/*">
    <button id="addProfileBtn">Add</button>
  </div>
  <div id="profilesContainer"></div>
  <div style="text-align:center;margin-top:12px">
    <button id="signOutBtn" class="btn ghost">Sign Out</button>
  </div>
</div>

<!-- HOME PAGE -->
<div id="homePage" style="display:none;">
  <header>
    <h1 id="welcomeTitle">FahadFlix</h1>
    <button onclick="signOut()">Sign Out</button>
  </header>
  <main>
    <h2>Movies & Shows</h2>
    <div id="movies">Loading...</div>
  </main>
  <div id="playerContainer"></div>
</div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCvd_IgPL3_gYjhfplngBboHWjSLRIhhIE",
  authDomain: "fahadflix-storage.firebaseapp.com",
  databaseURL: "https://fahadflix-storage-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "fahadflix-storage",
  storageBucket: "fahadflix-storage.appspot.com",
  messagingSenderId: "1064833913945",
  appId: "1:1064833913945:web:bf711e8b364fcfdf2b8d48"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();
let currentUser=null, profiles=[], mediaData={movies:[], shows:[]};

// ==== AUTH ====
document.getElementById('signInBtn').addEventListener('click', async()=>{
  const email=document.getElementById('email').value.trim();
  const pwd=document.getElementById('password').value.trim();
  if(!email||!pwd){ alert('Enter email & password'); return; }
  try{
    const userCred=await auth.signInWithEmailAndPassword(email,pwd);
    currentUser=userCred.user;
    await loadProfiles();
    showPage('profiles');
  }catch(e){ alert("Login failed: "+e.message); }
});

document.getElementById('signUpBtn').addEventListener('click', async()=>{
  const email=document.getElementById('email').value.trim();
  const pwd=document.getElementById('password').value.trim();
  if(!email||!pwd){ alert("Enter email & password"); return; }
  try{
    const userCred=await auth.createUserWithEmailAndPassword(email,pwd);
    currentUser=userCred.user;
    profiles=[{name:"User 1",img:"https://via.placeholder.com/150"}];
    await db.ref('profiles/'+currentUser.uid).set(profiles);
    showPage('profiles');
  }catch(e){ alert("Signup failed: "+e.message); }
});

// ==== PAGE SWITCH ====
function showPage(name){
  document.getElementById('authPage').style.display='none';
  document.getElementById('profilesPage').style.display='none';
  document.getElementById('homePage').style.display='none';
  document.getElementById(name).style.display='block';
}

// ==== PROFILES ====
const profilesContainer=document.getElementById('profilesContainer');
async function loadProfiles(){
  if(!currentUser) return;
  const snapshot = await db.ref('profiles/'+currentUser.uid).once('value');
  if(snapshot.exists()){ profiles = snapshot.val(); if(!Array.isArray(profiles)) profiles=[profiles]; }
  else { profiles=[{name:"User 1",img:"https://via.placeholder.com/150"}]; await db.ref('profiles/'+currentUser.uid).set(profiles);}
  renderProfiles();
}

async function saveProfiles(){ if(currentUser) await db.ref('profiles/'+currentUser.uid).set(profiles); }

document.getElementById('addProfileBtn').addEventListener('click', async()=>{
  const name=document.getElementById('newProfileName').value.trim();
  const file=document.getElementById('newProfileImage').files[0];
  if(!name){ alert('Enter name'); return; }
  if(!file){ alert('Pick an image'); return; }
  const reader=new FileReader();
  reader.onload=async e=>{
    if(!Array.isArray(profiles)) profiles=[];
    profiles.push({name,img:e.target.result});
    await saveProfiles();
    document.getElementById('newProfileName').value='';
    document.getElementById('newProfileImage').value='';
    renderProfiles();
  };
  reader.readAsDataURL(file);
});

function renderProfiles(){
  profilesContainer.innerHTML='';
  if(!Array.isArray(profiles)) profiles=[];
  profiles.forEach((p,index)=>{
    const div=document.createElement('div'); div.className='profile-card';
    div.innerHTML=`<img src="${p.img}" alt="${p.name}"><p>${p.name}</p>
      <button class="btn ghost editBtn">Edit</button>
      <button class="btn ghost deleteBtn">Delete</button>`;
    div.querySelector('img').addEventListener('click', ()=>{
      showPage('homePage'); document.getElementById('welcomeTitle').innerText='Welcome, '+p.name;
      fetchMovies();
    });
    div.querySelector('.editBtn').addEventListener('click', ()=>{
      const newName=prompt('Edit profile name:',p.name);
      if(newName){ profiles[index].name=newName; saveProfiles().then(renderProfiles); }
    });
    div.querySelector('.deleteBtn').addEventListener('click', async()=>{
      profiles.splice(index,1); await saveProfiles(); renderProfiles();
    });
    profilesContainer.appendChild(div);
  });
}

// Sign out
document.getElementById('signOutBtn').addEventListener('click', async()=>{ await auth.signOut(); currentUser=null; showPage('authPage'); });
function signOut(){ auth.signOut(); currentUser=null; showPage('authPage'); }

// ==== FETCH MOVIES.JSON FROM GITHUB ====
async function fetchMovies(){
  try{
    const response = await fetch("https://raw.githubusercontent.com/FXHDLE112/tes-html/main/movies.json");
    if(!response.ok) throw new Error("Failed to fetch movies.json");
    mediaData = await response.json();
    renderHome();
  }catch(e){ console.error("Error fetching movies:",e); document.getElementById("movies").innerText="Failed to load movies."; }
}

// ==== RENDER HOME & RESUME ====
function renderHome(){
  const container=document.getElementById("movies");
  container.innerHTML="";
  (mediaData.movies||[]).forEach(m=>{
    const card=document.createElement('div'); card.className='movie-card';
    card.innerHTML=`<h3>${m.title}</h3>`;
    card.onclick=()=>openVideoPlayer(m.title,m.url);
    container.appendChild(card);
  });
  (mediaData.shows||[]).forEach(s=>{
    if(s.seasons){ // show with episodes
      s.seasons.forEach(season=>{
        season.episodes.forEach(ep=>{
          const card=document.createElement('div'); card.className='movie-card';
          card.innerHTML=`<h3>${s.title} - ${ep.title}</h3>`;
          card.onclick=()=>openVideoPlayer(ep.title,ep.src);
          container.appendChild(card);
        });
      });
    } else { // single show
      const card=document.createElement('div'); card.className='movie-card';
      card.innerHTML=`<h3>${s.title}</h3>`;
      card.onclick=()=>openVideoPlayer(s.title,s.src);
      container.appendChild(card);
    }
  });
}

// ==== VIDEO PLAYER WITH RESUME ====
function openVideoPlayer(title, src){
  const container=document.getElementById('movies');
  container.innerHTML='';
  const playerContainer=document.getElementById('playerContainer');
  playerContainer.innerHTML='';

  const backBtn=document.createElement('button'); backBtn.innerText='Back'; backBtn.className='btn';
  backBtn.onclick=renderHome; playerContainer.appendChild(backBtn);

  const video=document.createElement('video'); video.controls=true; video.src=src;
  playerContainer.appendChild(video);

  // Load resume time from Firebase
  if(currentUser){
    db.ref(`resume/${currentUser.uid}/${title}`).once('value').then(snapshot=>{
      if(snapshot.exists()) video.currentTime = snapshot.val();
    });
  }

  // Save resume time on progress
  video.ontimeupdate = ()=>{
    if(currentUser && !video.paused){
      db.ref(`resume/${currentUser.uid}/${title}`).set(video.currentTime);
    }
  };

  video.play().catch(()=>{});
}
</script>
</body>
</html>
